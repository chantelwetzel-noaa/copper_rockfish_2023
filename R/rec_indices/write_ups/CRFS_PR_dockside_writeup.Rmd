---
title: "CRFS PR Index for `r params$species.name` in 2021"
author: "Melissa H. Monk"
date: "`r format(Sys.time(), '%B %d, %Y')`"
params:
    Model.number: 1
    species.name: "vermilion"
    survey.name: "CRFS PR dockside"
    assess.folder: "VRML"
    index.subfolder: "CRFS_PR_dockside"
output:
  bookdown::pdf_document2: 
    keep_tex: true
    keep_md: true
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \usepackage{placeins}
always_allow_html: true
---
```{r setup, echo = FALSE, include = FALSE, warning = FALSE, message = FALSE, cache = FALSE}
run_delta_glm <- TRUE
#knitr::opts_chunk$set(echo = params$printcode)
knitr::opts_chunk$set(echo = FALSE)
options(knitr.table.format = "latex")
Model_region <- c("NCA", "SCA")
spp  <- params$species.name
Spp <- stringr::str_to_title(spp)
model.region <- ifelse(params$Model.number==1, "northern model" , "southern model")
index.folder = paste0("C:/Stock_Assessments/",params$assess.folder,"_Assessment_2021/Indices_of_Abundance/")
index.path = paste0(index.folder,params$index.subfolder,"/",Model_region[params$Model.number])
source(paste0(index.folder,"dir_recent.R"))
model.dir <- dir_recent(dir = index.path, pattern = "2021")

load(paste0(model.dir,"/",Model_region[params$Model.number],"_",params$species.name,
                  "_",params$index.subfolder,"_deltaglm.RData"))

``` 


```{r, include= TRUE, warning = FALSE, message = FALSE}
source("C:/Stock_Assessments/VRML_Assessment_2021/Indices_of_abundance/01-Write up universal tables and figures.R")
```


```{r, echo = FALSE, warning = FALSE, message = FALSE }
library(devtools)
library(kableExtra)
library(knitr)
library(readxl)
library(xfun) # numbers to words
library(dplyr)
library(ggplot2)
library(rmarkdown)
library(png)
```


**CRFS Dockside Private Boat Index**

Catch and effort data from CRFS dockside sampling of private boats, 2004-2018, 
were provided by CDFW for use in this assessment. The data include catch (number 
of fish) by species, number of anglers (i.e. effort units are angler trips), 
angler-reported distance from shore (Area X: inside/outside of 3 nm), county, port, 
interview site, year, month, and CRFS district. The sample size of the 
unfiltered private boat CPUE data is much larger than the crfspr CPFV data set, 
with 391,279 trips statewide, 120,655 in southern California (south 
of Point Conception), and 270,064 north of Point Conception. 

*CRFS Private Boat Index: Data Preparation, Filtering, and Sample Sizes*
Records were limited to “PR1” sites, and only the hook-and-line gear type 
(Table \@ref(tab:tab-data-filter-crfspr)). 
Since this is a dockside index lacking precise fishing location information, we 
use the percent of groundfish within the catch from a trip as a proxy for retaining 
trips for index standardization. Similar to the CRFSS onboard index, we partitioned the 
data into areas north and south of Point Conception and applied the method 
separately to each data set.

Since 2005, the recreational fishery for shelf rockfish north of Point Conception 
has been closed from January through part of April and May.Angler reported distance 
from shore had no samples in the “outside 3 nm” category (Area X = 2) 
from 2004-2011, but was retained in the index standardization due to the relaxation 
of depth restrictions beginning in 2017. We retained `r dim(dat)[1]` drifts for 
index standardization, with `r dim(subset(dat, Target>0))[1]` drifts encountering `r spp` 
(Table \@ref(tab:tab-data-filter-crfspr)).  


*Northern California CRFS Private Boat Index: Model Selection, Fits, and Diagnostics*

Sample sizes by factors selected to model, excluding WAVE can be found in Tables 
\@ref(tab:tab-region-crfspr) and \@ref(tab:tab-year-crfspr).
We modeled retained catch per angler hour (CPUE; number of fish per angler hour) 
a Bayesian delta-GLM model.  Indices with a year and area interaction were not 
considered in model selection; trends in the average CPUE by region were similar 
in the filtered data set (Figure \@ref(fig:fig-areacpue-crfspr)). 

A `r pos.mod.dist` model  was 
selected for the positive observation GLM by 
a $\Delta AIC$ of `r ifelse(max(logn_or_gamma_aic[c(1,3),])==99999 , NA, round(max(logn_or_gamma_aic[c(1,3),]),2)) - round(min(logn_or_gamma_aic[c(1,3),], na.rm = T),2)` over a `r ifelse(pos.mod.dist=="Lognormal","Gamma","Lognormal")` model and supported by Q-Q plots of the positive observations fit to both distributions (Figure \@ref(fig:fig-dist-fits-crfspr)). The delta-GLM
method allows the linear predictors to differ between the binomial and positive models.
Based on AIC values from maximum likelihood fits Table \@ref(tab:tab-model-select-crfspr)), 
a main effects model including 
`r gsub("\\+","and",Model_selection$Model[which.min(binAIC$AIC[2:length(binAIC$AIC)]) + 1])` 
was fit for the binomial model and a main 
effects model including 
`r gsub("\\+","and",Model_selection$Model[which.min(posAIC$AIC[2:length(posAIC$AIC)]) + 1])` 
was fit for the  `r pos.mod.dist` model.
Models were fit using the “rstanarm” R package (version 2.21.1). Posterior predictive 
checks of the Bayesian model fit for the binomial model and the positive model 
were all reasonable (Figures \@ref(fig:fig-posterior-mean-crfspr)  and 
 \@ref(fig:fig-posterior-sd-crfspr)). The binomial model generated data sets with the 
 proportion zeros similar to the `r scales::percent(1-dim(dat %>% filter(Target>0))[1]/dim(dat)[1])`  zeroes in the observed data 
(Figure \@ref(fig:fig-propzero-crfspr)). The predicted marginal effects from 
both the binomial and `r pos.mod.dist` models can be found in (Figures \@ref(fig:fig-Dbin-marginal-crfspr) and \@ref(fig:fig-Dpos-marginal-crfspr)). The 
final index (Table \@ref(tab:tab-index-crfspr)) 
represents a similar trend to the arithmetic mean of the annual CPUE (Figure \@ref(fig:fig-cpue-crfspr)).


 \FloatBarrier


 
<!-- ******************************* TABLES ******************************** -->


 
`r table.data.filter`

`r table.subregion`

`r table.year`

\FloatBarrier

`r table.model.select`

\FloatBarrier

`r table.index`

\FloatBarrier



<!-- ****************************** FIGURES ******************************** --> 

```{r, fig-dist-fits-crfspr, warning = FALSE, message =FALSE, fig.cap = paste("Q-Q plot (top) of the positive observations lognormal gamma distributions and fitted values vs residuals for the", pos.mod.dist,"model (bottom).")}
ggpubr::ggarrange(pos.qq, pos.resid, ncol = 1)
```


```{r, fig-areacpue-crfspr, message = FALSE, warning = FALSE, fig.cap = paste("Arithmetic mean of CPUE by region for ", spp, "from the filtered data.")}
print(figure.subregion.CPUE)
```

```{r, echo = FALSE, fig-posterior-mean-crfspr, fig.cap = "Posterior predictive draws of the mean (x-axis) by year in replicate data sets generated by the delta model with a vertical line representing the observed mean in the data."}
print(figure.ppc.mean.by.year)
```

\FloatBarrier

```{r, echo = FALSE, fig-posterior-sd-crfspr, fig.cap = "Posterior predictive draws of the standard deviation by year (x-axis) in replicate data sets generated by the delta model with a vertical line representing the observed standard deviation in the data."}
print(figure.ppc.sd.by.year)
```

```{r, echo = FALSE, fig-propzero-crfspr, fig.cap = "Posterior predictive distribution of the proportion of zero observations (x-axis) in replicate data sets generated by the delta model with a vertical line representing the observed average proportion of zeros in the data."}
print(figure.ppc.stat.grouped)
```



```{r, fig-Dbin-marginal-crfspr, echo = FALSE, fig.cap = "Binomial marginal effects from the final model."}
# binomial model marginal components
sjPlot::plot_grid(figure.Dbin.list, tags = TRUE, margin = c(.1, .1, .1, .1)) 
```


```{r, fig-Dpos-marginal-crfspr, echo = FALSE,  fig.cap = "Positive model marginal effects from the final model."}
# positive model marginal components
sjPlot::plot_grid(figure.Dpos.list, tags = TRUE, margin = c(.1, .1, .1, .1)) 
```


```{r, fig-cpue-crfspr, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Standardized index and arithmetic mean of the CPUE from the filtered data. Each timeseries is scaled to its respective means."}
print(figure.CPUE)
```
