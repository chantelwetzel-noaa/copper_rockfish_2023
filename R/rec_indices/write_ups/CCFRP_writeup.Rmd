---
title: "CCFRP Index for `r params$species.name` in 2021"
author: "Melissa H. Monk"
date: "`r format(Sys.time(), '%B %d, %Y')`"
params:
    Model.number: 1
    species.name: "vermilion"
    survey.name: "CCFRP"
    assess.folder: "VRML"
    index.subfolder: "CCFRP"
output:
  bookdown::pdf_document2: 
    keep_tex: true
    keep_md: true
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \usepackage{placeins}
always_allow_html: true
---

```{r setup, echo = FALSE, include = FALSE, warning = FALSE, message = FALSE, cache = FALSE}
#knitr::opts_chunk$set(echo = params$printcode)
run_delta_glm <- FALSE
knitr::opts_chunk$set(echo = FALSE)
options(knitr.table.format = "latex")
Model_region <- c("NCA", "SCA")
spp  <- params$species.name
if(spp=="vermilion"){spp1 <- "vermilion rockfish"} else {spp1 <- spp}
Spp <- stringr::str_to_title(spp)
model.region <- ifelse(params$Model.number==1, "northern model" , "southern model")
index.folder = paste0("C:/Stock_Assessments/",params$assess.folder,"_Assessment_2021/Indices_of_Abundance/")
index.path = paste0(index.folder,params$index.subfolder,"/",Model_region[params$Model.number])
source(paste0(index.folder,"dir_recent.R"))
model.dir <- dir_recent(dir = index.path, pattern = "2021")

#load(paste0(model.dir,"/",Model_region[params$Model.number],"_",params$species.name,
#                  "_",params$index.subfolder,"_deltaglm.RData"))
library(dplyr)
if(params$species.name=="vermilion"){
  load(paste0(model.dir,"/",Model_region[params$Model.number],"_",params$species.name,
                  "_",params$index.subfolder,"_negbinomial.RData"))
  source(paste0(index.folder,"CCFRP/CCFRP_index_weighted_add_on.R"))
} else {
  load(paste0(model.dir,"/",Model_region[params$Model.number],"_",params$species.name,
                  "_",params$index.subfolder,"_deltaglm.RData"))
  }

``` 



```{r, echo = FALSE, warning = FALSE, message = FALSE }
library(devtools)
library(kableExtra)
library(knitr)
library(readxl)
library(xfun) # numbers to words
library(dplyr)
library(ggplot2)
library(rmarkdown)
library(png)
```


```{r, include= TRUE, warning = FALSE, message = FALSE}
source("C:/Stock_Assessments/VRML_Assessment_2021/Indices_of_abundance/01-Write up universal tables and figures.R")
```




**California Collaborative Fisheries Research Program Index**

The California Collaborative Fisheries Research Program, [CCFRP](https://www.mlml.calstate.edu/ccfrp/), 
is a fishery-independent 
hook-and-line survey designed to monitor nearshore fish populations at a series of sampling 
locations both inside and adjacent to MPAs along the central California coast 
[@Wendt2009; @Starr2015].  The CCFRP survey began in 2007 and was originally
designed as a statewide program in collaboration with NMFS scientists and fishermen. 
From 2007-2016 the CCFRP project was focused on the central California coast, and has monitored 
four MPAs consistently.  In 2017, 
the program was expanded coastwide within California.  The index of abundance was 
developed from the four MPAs sampled consistently (A&ntilde;o Nuevo and Point Lobos 
by Moss Landing Marine Labs; Point Buchon and Piedras Blancas by Cal Poly).

The survey design for CCFRP consists a number 500 x 500 m cells both within and 
outside each MPA. On any given survey day site cells are randomly 
selected within a stratum (MPA and/or reference cells).  CPFVs are chartered 
for the survey and the fishing captain is allowed to search within the cell for 
a fishing location.  During a sampling event, each cell is fished for a total of 
30-45 minutes by volunteer anglers. Each fish encountered is recorded, measured, 
and can be linked back to a particular angler, and released (or descended to depth). 
Starting in 2017, a subset of fish have been retained to collect otoliths and fin 
clips that provide needed biological information for nearshore species. For the index of abundance, CPUE was modeled at the level of the drift, similar to the 
fishery-dependent onboard observer survey described above.


*CCFRP Index: Data Preparation, Filtering, and Sample Sizes*

The CCFRP data are quality controlled at the time they are key punched and little 
filtering was needed for the index. 
Cells not consistently sampled over time were excluded as well as cells that never encountered `r spp1`. CCFRP samples shallower 
depths to avoid barotrauma-induced mortality.  We retained `r dim(dat)[1]` drifts for index standardization, with `r dim(subset(dat, Target>0))[1]` drifts encountering `r spp1`.
  


*CCFRP Index: Model Selection, Fits, and Diagnostics*

Sample sizes by factors selected to model, excluding WAVE can be found in Tables 
\@ref(tab:tab-region-ccfrp) and \@ref(tab:tab-year-ccfrp).
We modeled retained catch per angler hour (CPUE; number of fish per angler hour) 
a Bayesian delta-GLM model.  Indices with a year and area interaction were not 
considered in model selection; trends in the average CPUE by region were similar 
in the filtered data set (Figure \@ref(fig:fig-areacpue-ccfrp)). Plots of the arithmetic 
mean by inside (MPA) and outside (REF) MPAs over time is in Figure \@ref(fig:fig-sitecpue-ccfrp).

A negative binomial model was fit to the drift-level data (catch with a log offset for angler 
hours). Because the averaged observed CPUE inside MPAs and in the reference sites exhibited 
differing trends, we explored a YEAR:SITE interaction, which was selected as the best 
fit model by AIC Table \@ref(tab:tab-model-select-ccfrp)), The final model included
`r gsub("\\+","and",nbModel_selection$Model[which.min(nbinAIC$AIC[2:length(nbinAIC$AIC)]) + 1])`.
The model was fit using the “rstanarm” R package (version 2.21.1). Posterior predictive 
checks of the Bayesian model fit for the binomial model and the positive model 
were all reasonable (Figures \@ref(fig:fig-posterior-mean-ccfrp)  and 
 \@ref(fig:fig-posterior-sd-ccfrp)). The negative binomial model generated data sets with the 
 proportion zeros similar to the `r scales::percent(1-dim(dat %>% filter(Target>0))[1]/dim(dat)[1])`  zeroes in the observed data 
(Figure \@ref(fig:fig-propzero-ccfrp)). The predicted marginal effects from the model can be found in (Figures \@ref(fig:fig-Dnbin-marginal-ccfrp)). 

Based on work completed at the SWFSC, we estimate that the percent of rocky reef habitat from Point Conception to the California border within California state waters is 892 $km^2$, of which approximately 23% is in MPAs that prohibit the harvest of groundfish (pers comm. Rebecca Miller, UCSC). There is recreational fishing outside of state waters, but habitat maps are not available at the same 2-m resolution and do not allow for direct comparisons. High-resolution habitat maps are not available for the state waters south of Point Conception.

The final index was weighted, giving 20% of the model weight to MPAs and 80% of model 
weight to the "open" areas within the state. The CCFRP index includes all of the 
MPAs currently sampled from 2017-2020 and the core central California sampling sites 
from 2007-2016.  Trends among all of the MPAs sampled increased along the entire coast 
from 2017-2020.  The final index (Table \@ref(tab:tab-index-ccfrp)) 
represents a similar trend to the arithmetic mean of the annual CPUE (Figure \@ref(fig:fig-cpue-ccfrp)).

To visualize the affect of weighting on the index, Figure (\@ref(fig:fig-weighted-cpue-ccfrp)) 
shows the unweighted index and the index with 10-60% of the weight given to MPAs versus 
open areas.  Each of these indices are scaled to their means to allow for direct comparison.


<!-- ******************************* TABLES ******************************** -->

\newpage

`r table.subregion`

`r table.depth`

`r table.year`

\FloatBarrier

`r table.model.select`

\FloatBarrier

`r table.index`

\FloatBarrier



<!-- ****************************** FIGURES ******************************** --> 

<!--
r, fig-dist-fits-ccfrp, warning = FALSE, message =FALSE, fig.cap = paste("Q-Q plot (top) of the positive observations lognormal gamma distributions and fitted values vs residuals for the", pos.mod.dist, "model (bottom).")}
ggpubr::ggarrange(pos.qq, pos.resid, ncol = 1)

-->


```{r, fig-areacpue-ccfrp, message = FALSE, warning = FALSE, fig.cap = paste("Arithmetic mean of CPUE by region for ", params$species.name, "from the filtered data. The areas used are in the text.")}
print(figure.subregion.CPUE)
```

```{r, fig-sitecpue-ccfrp, message = FALSE, warning = FALSE, fig.cap = paste("Arithmetic mean of CPUE by inside/outside MPAs for ", params$species.name, "from the filtered data. The areas used are in the text.")}
print(figure.SITE.rawCPUE)
```


```{r, fig-propzero-ccfrp, echo = FALSE, fig.cap = "Posterior predictive distribution of the proportion of zero observations (x-axis) in replicate data sets generated by the delta model with a vertical line representing the observed average in the data."}
print(figure_Dnbin_prop_zero)
```


```{r, fig-posterior-mean-ccfrp, echo = FALSE, fig.cap = "Posterior predictive draws of the mean (x-axis) by year in replicate data sets generated by the negative binomial model with a vertical line representing the observed mean in the data."}
print(figure.ppc.mean.by.year)

```


```{r, fig-posterior-sd-ccfrp, echo = FALSE, fig.cap = "Posterior predictive draws of the standard deviation (x-axis) in replicate data sets generated by the negative binomial model with a vertical line representing the observed mean in the data."}
print(figure.ppc.sd.by.year)
```


```{r, fig-Dnbin-marginal-ccfrp, echo = FALSE, fig.cap = "Negative ninomial marginal effects from the unweighted model."}
# binomial model marginal components
sjPlot::plot_grid(figure.Dnbin.list, tags = TRUE, margin = c(.1, .1, .1, .1)) 
```



```{r, fig-cpue-ccfrp, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Standardized index and arithmetic mean of the CPUE from the filtered data. Each timeseries is scaled to its respective means."}
print(figure.CPUE)
```




<!--{r, fig-Dpos-marginal-ccfrp, echo = FALSE,  fig.cap = "Positive model marginal effects from the final model."}
# positive model marginal components
sjPlot::plot_grid(figure.Dpos.list, tags = TRUE, margin = c(.1, .1, .1, .1)) 
-->


```{r, fig-weighted-cpue-ccfrp, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Standardized index with differing weighting to the MPAs from 10% to 60%. Each index is scaled to its respective means."}
print(Area.weighted.options)
```
